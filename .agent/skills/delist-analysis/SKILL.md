---
name: delist-analysis
description: 分析退市股票的退市原因、首次通知日期和置换方案，支持历史分析和实时风险监控
---

# 退市分析 Skill

## 概述

本 Skill 支持两种使用模式：

| 模式 | 目的 | 输入 | 输出 |
|-----|------|-----|------|
| **历史分析** | 构建PIT数据用于回测 | 已退市股票代码 + **退市日期** | 结构化退市信息 |
| **实时监控** | 规避持仓退市风险 | 持仓股票列表 | 风险预警信号 |

本 Skill 采用**严格校验机制**，任何不符合预期的情况都需要人工介入。

> [!IMPORTANT]
> **历史分析模式必须使用 `--before-date` 参数！**
> 
> 用户输入通常包含退市日期，**必须**将其传递给 `filter-delist` 命令：
> ```bash
> filter-delist <股票代码> --before-date <退市日期> --limit 300
> ```
> 不使用此参数会导致搜索最近的公告，历史退市股票将返回 NOT_FOUND。

---

## ⚠️ 使用规范

### 输入限制

**用户必须明确指定待分析的股票代码列表。**

| 规则 | 说明 |
|-----|------|
| ✅ 必须 | 用户明确提供股票代码（如 `601989, 601028`） |
| ❌ 禁止 | Agent 擅自扩展分析范围（如发现"类似案例"后自行添加） |
| ❌ 禁止 | Agent 未经用户确认添加或删除任何股票代码 |

### 执行前确认

在开始分析前，Agent 必须：
1. 列出用户指定的所有股票代码
2. 确认数量与用户要求一致
3. 不得因"关联性"、"相似性"等理由擅自添加其他股票

### 示例

**正确 ✅**
```
用户: 请分析 601989, 601028
Agent: 好的，我将分析以下 2 只股票：601989、601028
```

**错误 ❌**
```
用户: 请分析 601989, 601028
Agent: 好的，我发现 600705 也是类似案例，一并分析了 3 只股票
```

---

## ⛔ 禁止批量脚本

> [!CAUTION]
> **绝对禁止**编写任何批量处理脚本！

| 禁止行为 | 原因 |
|---------|------|
| ❌ 编写 Python 脚本循环处理多个股票 | 每个股票需要 Agent 阅读公告、判断类型、提取信息 |
| ❌ 创建"自动化"分析流程 | 公告内容复杂，需要人类级理解和判断 |
| ❌ 试图"优化"处理速度 | 准确性 > 速度，错误的PIT数据会导致回测偏差 |

**正确做法**：对每只股票，Agent 必须：
1. 调用 `filter-delist` 获取公告列表
2. **阅读**公告标题，识别退市类型
3. 下载并**阅读** PDF 内容，理解公告详情
4. **逐个判断**提取关键信息（日期、置换方案等）
5. 校验后追加到 CSV

---

## 📌 数据来源约束

> [!IMPORTANT]
> **必须使用 cninfo_tools.py 获取数据，禁止网络搜索！**

### 唯一数据来源

| ✅ 允许 | ❌ 禁止 |
|--------|--------|
| `cninfo_tools.py list-announcements` | 使用 `search_web` 搜索公告 |
| `cninfo_tools.py download-pdf` | 通过浏览器访问第三方网站 |
| `cninfo_tools.py extract-text` | 引用"百度/Google搜索结果" |

### 为什么禁止网络搜索？

1. **URL 不可靠**：搜索结果的公告链接经常失效 (404)
2. **信息不完整**：搜索引擎摘要可能遗漏关键细节
3. **来源不可追溯**：无法验证信息的真实性
4. **PIT 污染**：可能混入事后信息，破坏数据的时间一致性

### 公告URL规范

所有 `公告URL` 字段必须是 **巨潮资讯** 的直接链接：
- ✅ `http://static.cninfo.com.cn/finalpage/2025-08-30/1224625027.PDF`
- ❌ `https://www.baidu.com/link?...`
- ❌ `https://finance.sina.com.cn/...`

---

## 📁 临时文件目录

所有临时文件必须放在 `temp/` 目录中：

| 文件类型 | 路径示例 |
|---------|----------|
| 下载的 PDF | `temp/<stock_code>.pdf` |
| 校验用 JSON | `temp/<stock_code>_data.json` |

> [!NOTE]
> 分析完成后，使用清理命令删除 `temp/` 目录下的临时文件。

## 🔢 股票代码格式规范

> [!WARNING]
> 股票代码必须始终作为 **6位字符串** 处理，禁止转换为数字！

### 常见错误

| 错误 | 正确 | 说明 |
|-----|------|------|
| `1` | `"000001"` | 前导零被省略 |
| `688` | `"000688"` | 整数转换丢失 |
| `600150` (无引号) | `"600150"` | JSON中必须用引号 |

### JSON 中的写法

```json
{
  "code": "000001",
  "置换标的code": "600150"
}
```

### 读取 CSV 时的注意事项

如果从 CSV 读取股票代码，**必须**指定 `dtype`：

```python
df = pd.read_csv("file.csv", dtype={"code": str})
```

### 验证规则

股票代码校验会检查：
- 长度必须为 6
- 必须全为数字字符
- 类型必须是字符串（不能是 int）

---

# 模式一：历史分析（PIT数据构建）

## ⚠️ PIT (Point-in-Time) 关键性

**本模式的核心目标是构建 PIT 数据。**

### 关键时间点定义

**从量化策略角度**：策略只需知道"首次退市通知日"即可触发卖出信号，成交与否由回测引擎根据行情数据自动处理。

| 时间点 | 字段名 | 定义 | 策略意义 | 必填？ |
|-------|--------|------|---------|-------|
| **首次退市确认日** | 首次退市通知日 | 投资者**首次确定知道**股票将要退市的日期 | ✅ **策略触发卖出的日期** | ✅ 必填 |
| **退市日期** | 退市日期 | 最后交易日/摘牌日 | ✅ 最终退市确认 | ✅ 必填 |

**策略处理逻辑**：
```python
if date >= df['首次退市通知日']:
    触发卖出信号 → 尝试卖出
    # 成交与否由回测引擎自动判断（检查行情数据是否可交易）
```

### ⚠️ 首次退市确认日的正确定义

**关键原则：投资者首次"确定"知道股票将要退市的日期**

| 退市类型 | 首次退市确认日 = | 说明 |
|---------|----------------|------|
| **MERGE** | 董事会通过换股吸收合并**预案**的公告日 | 预案公告后，投资者确定知道将被合并 |
| **VOLUNTARY** | 股东大会决议通过主动退市的公告日 | 决议通过后，确定将主动退市 |
| **TENDER** | 要约收购完成+申请终止上市的公告日 | 收购完成后，确定将退市 |
| **FORCE_*** | 交易所决定终止上市的公告日 | 交易所决定后，确定将退市 |

### ❌ 常见错误

| 错误做法 | 为什么错 |
|---------|---------|
| 使用"筹划停牌"日期 | 筹划≠确定，很多筹划最终没有退市 |
| 使用"终止上市暨摘牌"日期 | 这是最后的公告，太晚了，投资者已锁死 |
| 使用"风险提示"日期 | 这只是提示，不是确认 |

### ✅ 正确示例

**601989 中国重工（吸收合并）：**
```
董事会通过预案                                    退市日
     ↓                                               ↓
  2024-09-19                                    2025-09-05
     │                                               │
     │←────────── 策略卖出窗口 ──────────────────→│
     首次确认退市，触发卖出                          摘牌
```

**601028 玉龙股份（主动退市）：**
```
股东大会决议通过                退市日
       ↓                         ↓
    2025-03-22                2025-05-27
       │                         │
       │←─── 策略卖出窗口 ────→│
       首次确认退市                摘牌
```

**核心逻辑**：只要标注出"首次退市通知日"，策略就会在该日期触发卖出，成交与否由回测引擎根据行情数据判断。





### ⚠️ MERGE 类型特别注意：区分收购方与被收购方

**吸收合并涉及两个公司，只有被收购方会退市！**

| 角色 | 公告发布者 | 是否退市 | 示例 |
|-----|----------|---------|------|
| **收购方/吸收方** | 会发布预案 | ❌ 不退市，存续 | 中国船舶(600150) |
| **被收购方/被吸收方** | 会发布预案 | ✅ 会退市 | 中国重工(601989) |

**如何识别角色：**

1. **看公告标题结构**：
   - "A公司换股吸收合并B公司" → A是收购方（存续），B是被收购方（退市）
   
2. **看公告中的表述**：
   - "本公司为吸收合并方" → 收购方，不退市
   - "本公司为被吸收合并方" → 被收购方，会退市
   - "本公司将终止上市并注销法人资格" → 被收购方，会退市

3. **验证股票代码**：
   - 我们分析的股票代码应该是**被收购方**
   - 公告中提到的置换标的应该是**收购方**

## 退市分类体系

### 分类定义

| 分类代码 | 分类名称 | 说明 |
|---------|---------|------|
| MERGE | 吸收合并退市 | 被其他上市公司换股吸收合并 |
| RECODE | 更名换码 | 证券简称和代码变更，原代码不再使用，1:1自动平移 |
| VOLUNTARY | 主动退市 | 公司以股东大会决议方式主动申请终止上市 |
| TENDER | 要约收购退市 | 收购方完成要约收购后申请终止上市 |
| FORCE_FIN | 强制退市_财务 | 连续亏损、净资产为负、营收过低等财务原因 |
| FORCE_TRADE | 强制退市_交易 | 股价低于1元、市值低于标准等交易原因 |
| FORCE_FRAUD | 强制退市_违法 | 财务造假、重大违法等 |
| FORCE_NORM | 强制退市_规范 | 信息披露违规、未及时披露年报等 |
| OTHER | 其他 | 无法归类的情况 |

### 分类特征识别

#### MERGE (吸收合并退市)
公告标题特征：
- "换股吸收合并"
- "发行股份购买资产并吸收合并"
- "被XXX吸收合并"

#### VOLUNTARY (主动退市)
公告标题特征：
- "主动终止上市"
- "以股东大会决议方式...终止上市"
- "撤回公司股票在...交易"

#### TENDER (要约收购退市)
公告标题特征：
- "要约收购"
- "收购报告书"
- "收购完成后...终止上市"

#### FORCE_FIN (强制退市_财务)
公告标题特征：
- "连续亏损"
- "净资产为负"
- "营业收入低于"
- "触发财务类退市"

#### FORCE_TRADE (强制退市_交易)
公告标题特征：
- "股价低于面值"
- "连续20个交易日收盘价低于1元"
- "市值低于"
- "触发交易类退市"

#### FORCE_FRAUD (强制退市_违法)
公告标题特征：
- "重大违法"
- "财务造假"
- "虚假陈述"
- "欺诈发行"

#### FORCE_NORM (强制退市_规范)
公告标题特征：
- "未按期披露"
- "信息披露违规"
- "无法按时披露年报"

#### RECODE (更名换码)
公告标题特征：
- "证券简称和证券代码变更"
- "变更证券简称和证券代码"
- "变更后的证券代码"
- "证券代码变更"

**注意**：RECODE 与 MERGE 的区别：
- **法人主体**：RECODE 法人主体存续，MERGE 法人主体注销
- **置换比例**：RECODE 固定为 1:1，MERGE 通常非 1:1

---

## 字段必填规则

### 通用必填字段（所有分类）

| 字段 | 必填 | 校验规则 | 回测用途 |
|-----|-----|---------|---------|
| code | ✅ | 6位数字 | 标识股票 |
| 名称 | ✅ | 非空字符串 | 记录用途 |
| 退市日期 | ✅ | YYYY-MM-DD 格式 | 最后交易日 |
| 退市原因 | ✅ | 非空字符串 | 记录用途 |
| 退市类型 | ✅ | 分类代码 | 决定后续处理逻辑 |
| **首次退市通知日** | ✅ **必须** | YYYY-MM-DD | **策略触发卖出** |
| 来源公告 | ✅ | 非空字符串 | 溯源 |
| 公告URL | ✅ | HTTP URL | 溯源 |

### 条件必填字段（MERGE/RECODE类型）⚠️ 回测关键

| 字段 | MERGE | RECODE | 其他类型 | 回测用途 |
|-----|-------|--------|---------|----------|
| 置换标的code | ✅ **必须** | ✅ **必须** | NaN | 持仓转换目标 |
| 置换标的名称 | ✅ **必须** | ✅ **必须** | NaN | 记录 |
| 置换比例 | ✅ **必须** | ✅ **固定1:1** | NaN | 新股数 = 原股数 × 比例 |
| 置换完成日期 | ✅ **必须** | ✅ **必须** | NaN | 持仓转换生效日 |

> [!WARNING]
> **MERGE/RECODE类型缺少置换字段会导致回测持仓价值归零！** 必须完整填写。
> **RECODE类型的置换比例必须为 `1:1`**，因为更名换码是等值平移。


### 日期逻辑校验

```
首次退市通知日 < 退市日期
```

不满足此逻辑将触发校验错误。

### 分类特定字段规则

#### MERGE (吸收合并退市) ⚠️ 置换字段必填

> [!IMPORTANT]
> **置换字段对回测至关重要！** 这是持仓置换延续的关键。

| 字段 | 必填 | 校验规则 | 回测用途 |
|-----|-----|---------|---------|
| 置换标的code | ✅ 必须 | 6位数字 | 持仓转换的目标股票 |
| 置换标的名称 | ✅ 必须 | 公司简称 | 记录用途 |
| 置换比例 | ✅ 必须 | 格式：1:X.XXXX | 新股数 = 原股数 × X |
| 置换完成日期 | ✅ 必须 | YYYY-MM-DD | 持仓转换生效日期 |

**回测置换逻辑示例：**
```python
# 601989 中国重工 → 600150 中国船舶，置换比例 1:0.1339
if date == df['置换完成日期']:
    new_shares = old_shares * 0.1339
    portfolio['600150'] = new_shares  # 持仓延续为新股
    del portfolio['601989']           # 原股票消失
```

**为什么不能为NaN？**
如果置换字段缺失，回测将无法正确处理持仓：
- ❌ 股票直接消失，组合价值归零（错误）
- ✅ 股票置换为新股，组合价值延续（正确）


#### VOLUNTARY (主动退市)

| 字段 | 必填 | 值要求 |
|-----|-----|--------|
| 置换标的code | ❌ 不适用 | 必须为 "NaN" |
| 置换标的名称 | ❌ 不适用 | 必须为 "NaN" |
| 置换比例 | ❌ 不适用 | 必须为 "NaN" |
| 置换完成日期 | ❌ 不适用 | 必须为 "NaN" |

#### TENDER (要约收购退市)

根据要约类型分两种情况：

**现金要约（无换股）**：
| 字段 | 必填 | 值要求 |
|-----|-----|--------|
| 置换标的code | ❌ 不适用 | 必须为 "NaN" |
| 置换标的名称 | ❌ 不适用 | 必须为 "NaN" |
| 置换比例 | ❌ 不适用 | 必须为 "NaN" |
| 置换完成日期 | ❌ 不适用 | 必须为 "NaN" |

**股票要约（有换股）**：
| 字段 | 必填 | 值要求 |
|-----|-----|--------|
| 置换标的code | ✅ 必须存在 | 6位数字 |
| 置换标的名称 | ✅ 必须存在 | 公司简称 |
| 置换比例 | ✅ 必须存在 | 格式：1:X.XXXX |
| 置换完成日期 | ✅ 必须存在 | YYYY-MM-DD |

#### FORCE_* (所有强制退市类型)

| 字段 | 必填 | 值要求 |
|-----|-----|--------|
| 置换标的code | ❌ 不适用 | 必须为 "NaN" |
| 置换标的名称 | ❌ 不适用 | 必须为 "NaN" |
| 置换比例 | ❌ 不适用 | 必须为 "NaN" |
| 置换完成日期 | ❌ 不适用 | 必须为 "NaN" |

---

## 严格校验机制

### 校验流程

```
提取完成后，必须执行以下校验：

1. 基础字段校验
   ├─ code 格式校验 (6位数字)
   ├─ 日期格式校验 (YYYY-MM-DD)
   ├─ 日期逻辑校验 (首次通知日 < 退市日期)
   └─ 必填字段非空校验

2. 分类识别校验
   ├─ 退市类型必须是定义的分类代码之一
   └─ 如果无法确定分类 → 抛出错误

3. 分类字段校验
   ├─ MERGE: 置换相关4个字段全部必须有值
   ├─ VOLUNTARY/FORCE_*: 置换相关4个字段必须全为NaN
   └─ 不符合 → 抛出错误

4. 交叉校验
   ├─ 置换比例格式校验 (1:X.XXXX)
   ├─ 置换完成日期 应在 首次通知日 之后
   └─ 异常 → 抛出错误
```

### 错误处理规则

**错误分为两类：可跳过错误（继续处理其他股票）和 严格错误（必须停止）**

#### 可跳过错误（记录后继续）

| 错误类型 | 触发条件 | 处理方式 |
|---------|---------|---------| 
| NOT_FOUND | 未找到任何退市相关公告（增加 limit 后仍找不到） | **跳过**，记录到跳过列表 |

**跳过时的输出格式：**
```
⏭️ 跳过: XXXXXX (公司名)
原因: NOT_FOUND
详情: 未找到退市相关公告
```

**批量处理结束后，汇总报告跳过的股票：**
```
========================================
⏭️ 跳过股票汇总 (共 X 只)
========================================
| 代码 | 名称 | 原因 |
|------|------|------|
| 000yyy | 丙公司 | 未找到退市公告 |
```

#### 严格错误（必须停止并报告用户）

| 错误类型 | 触发条件 | 处理方式 |
|---------|---------|---------|
| MISSING_REQUIRED | 通用必填字段缺失 | 停止，报告缺失字段 |
| INVALID_FORMAT | 日期/代码格式错误 | 停止，报告格式问题 |
| UNKNOWN_TYPE | 无法识别退市类型 | 停止，请求人工确认 |
| FIELD_CONFLICT | 字段值与分类不匹配 | 停止，报告冲突详情 |
| LOGIC_ERROR | 日期逻辑错误 | 停止，报告逻辑问题 |
| PARSE_FAILED | 关键信息提取失败 | 停止，请求人工解析 |

### 错误报告格式

当发生错误时，必须以以下格式报告：

```
❌ 校验失败

股票代码: XXXXXX
股票名称: XXX
错误类型: [错误类型代码]
错误详情: [具体描述]

已提取的数据:
{
  "field1": "value1",
  "field2": "value2",
  ...
}

需要用户处理:
1. [具体要求1]
2. [具体要求2]

请确认后，提供正确的值或同意使用 "待确认" 标记继续。
```

---

## 工作流程

### 步骤 1: 筛选退市相关公告

**⚠️ 公告搜索策略**

巨潮资讯 API 支持日期范围搜索（`seDate` 参数），**历史分析必须使用此功能**定位相关公告。

**⚡ 历史分析模式（必须使用 `--before-date`）**

> [!WARNING]
> 历史退市股票**必须**传入退市日期，否则会搜索最近公告导致 NOT_FOUND！

```bash
# 必须使用 --before-date 参数
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py filter-delist <股票代码> --before-date <退市日期> --limit 300
```

**工作原理：**
- 自动计算退市日期前 18 个月的时间范围
- 只搜索该时间段内的公告，避免漏掉历史公告
- 退市通知通常在退市前 6-18 个月发布

**示例：**
```bash
# 000043，退市日期 2019-12-16
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py filter-delist 000043 --before-date 2019-12-16 --limit 300
# 这会搜索 2018-06-24 ~ 2019-12-16 期间的公告
```


**自定义日期范围**

```bash
# 同时指定开始和结束日期
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py filter-delist <stock_code> --after-date 2024-01-01 --before-date 2025-12-31
```

**扩展搜索（需要时）**

如果需要查找更早期的公告（如董事会预案），可以：

1. **扩大日期范围**：
```bash
# 退市日期前 24 个月
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py filter-delist <stock_code> --after-date 2022-01-01 --before-date 2025-12-31
```

2. **使用关键词搜索**：

| 退市类型 | 建议关键词 |
|---------|-----------|
| MERGE | "筹划重大资产重组"、"筹划换股吸收合并"、"重大事项停牌" |
| RECODE | "证券简称"、"证券代码变更"、"变更证券代码" |
| VOLUNTARY | "筹划主动退市"、"董事会决议"、"重大事项" |
| TENDER | "要约收购意向"、"筹划要约"、"控制权变更" |

```bash
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py list-announcements <stock_code> --keyword "筹划重大资产重组" --limit 200
```

**⚡ 核心原则：找到投资者"首次确定知道"退市的公告**




### 步骤 2: 识别退市类型

浏览公告标题，根据特征识别退市类型：

**判断逻辑：**
```
if 公告含 "换股吸收合并" or "发行股份购买资产并吸收合并":
    类型 = MERGE
elif 公告含 "证券简称和证券代码变更" or "变更证券代码":
    类型 = RECODE
elif 公告含 "主动终止上市" or "股东大会决议...终止":
    类型 = VOLUNTARY
elif 公告含 "要约收购":
    类型 = TENDER
elif 公告含 "连续亏损" or "净资产为负" or "财务类退市":
    类型 = FORCE_FIN
elif 公告含 "股价低于" or "市值低于" or "交易类退市":
    类型 = FORCE_TRADE
elif 公告含 "重大违法" or "财务造假":
    类型 = FORCE_FRAUD
elif 公告含 "未按期披露" or "规范类退市":
    类型 = FORCE_NORM
else:
    类型 = UNKNOWN → 必须抛出错误请求人工确认
```

### 步骤 3: 按分类确定需要的公告

#### MERGE 需要的公告：
| 序号 | 公告类型 | 提取信息 |
|-----|---------|---------|
| 1 | 首次提示公告 | 首次退市通知日 |
| 2 | 换股方案/实施公告 | 置换标的、置换比例 |
| 3 | 终止上市公告 | 退市日期 |
| 4 | 换股实施结果公告 | 置换完成日期 |

#### RECODE 需要的公告：
| 序号 | 公告类型 | 提取信息 |
|-----|---------|---------|
| 1 | 证券简称和代码变更公告 | 首次退市通知日、新代码、置换完成日期（复牌日） |

> [!TIP]
> **RECODE 特别提示**：
> - 置换比例固定为 `1:1`
> - 置换完成日期 = 复牌日（新代码启用日期）
> - 退市日期 = 复牌日（原代码最后一天）
> - 首次退市通知日 = 变更公告发布日

#### VOLUNTARY 需要的公告：
| 序号 | 公告类型 | 提取信息 |
|-----|---------|---------|
| 1 | 主动终止上市公告 | 首次退市通知日、退市原因 |
| 2 | 终止上市暨摘牌公告 | 退市日期 |

#### FORCE_* 需要的公告：
| 序号 | 公告类型 | 提取信息 |
|-----|---------|---------|
| 1 | 触发退市条件公告 | 首次退市通知日、退市原因 |
| 2 | 退市整理期公告 | 退市整理期开始日 |
| 3 | 终止上市公告 | 退市日期 |

### 步骤 4: 下载并提取信息

```bash
# 下载 PDF
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py download-pdf "<url>" --output temp/<stock_code>.pdf

# 提取文本
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py extract-text temp/<stock_code>.pdf --max-pages 5
```

### 步骤 5: 执行校验

提取完成后，**必须执行完整校验**。先将数据保存为 JSON 文件，然后校验：

```bash
# 保存数据到临时文件 temp/<stock_code>_data.json
# 内容: {"code":"xxxxxx", "名称":"xxx", ...}

# 校验数据
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py validate --file temp/<stock_code>_data.json
```

如果校验通过，继续保存。如果校验失败，**必须停止并报告用户**。

### 步骤 6: 保存结果

只有校验通过后才能保存：

```bash
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py append-result --csv <output_file> --file temp/<stock_code>_data.json
```

---

## 典型案例

### 案例 1: MERGE (吸收合并退市) - 601989 中国重工

**提取结果：**
```json
{
  "code": "601989",
  "名称": "中国重工",
  "退市日期": "2025-09-05",
  "退市原因": "被中国船舶换股吸收合并",
  "退市类型": "MERGE",
  "首次退市通知日": "2024-09-19",
  "置换标的code": "600150",
  "置换标的名称": "中国船舶",
  "置换比例": "1:0.1339",
  "置换完成日期": "2025-09-04",
  "来源公告": "关于公司股票终止上市的公告",
  "公告URL": "http://static.cninfo.com.cn/finalpage/2025-08-30/1224625027.PDF"
}
```

**校验结果：✅ 通过**
- [x] code 格式正确
- [x] 退市类型 = MERGE
- [x] 置换标的code 存在且格式正确
- [x] 置换标的名称 存在
- [x] 置换比例 格式正确 (1:0.1339)
- [x] 置换完成日期 存在且在合理范围
- [x] 首次通知日 < 退市日期

### 案例 2: VOLUNTARY (主动退市) - 601028 玉龙股份

**提取结果：**
```json
{
  "code": "601028",
  "名称": "玉龙股份",
  "退市日期": "2025-05-27",
  "退市原因": "主动申请终止上市",
  "退市类型": "VOLUNTARY",
  "首次退市通知日": "2025-03-22",
  "置换标的code": "NaN",
  "置换标的名称": "NaN",
  "置换比例": "NaN",
  "置换完成日期": "NaN",
  "来源公告": "关于以股东大会决议方式主动终止公司股票上市的公告",
  "公告URL": "http://..."
}
```

**校验结果：✅ 通过**
- [x] code 格式正确
- [x] 退市类型 = VOLUNTARY
- [x] 置换标的code = NaN (符合VOLUNTARY规则)
- [x] 置换标的名称 = NaN (符合VOLUNTARY规则)
- [x] 置换比例 = NaN (符合VOLUNTARY规则)
- [x] 置换完成日期 = NaN (符合VOLUNTARY规则)

### 案例 3: RECODE (更名换码) - 深赤湾A → 招商港口

**提取结果：**
```json
{
  "code": "000022",
  "名称": "深赤湾A",
  "退市日期": "2018-12-26",
  "退市原因": "重大资产重组后更名换码为招商港口",
  "退市类型": "RECODE",
  "首次退市通知日": "2018-12-21",
  "置换标的code": "001872",
  "置换标的名称": "招商港口",
  "置换比例": "1:1",
  "置换完成日期": "2018-12-26",
  "来源公告": "关于变更证券简称和证券代码的公告",
  "公告URL": "http://static.cninfo.com.cn/finalpage/2018-12-21/1205660326.PDF"
}
```

**校验结果：✅ 通过**
- [x] code 格式正确
- [x] 退市类型 = RECODE
- [x] 置换标的code 存在且格式正确
- [x] 置换标的名称 存在
- [x] 置换比例 = 1:1 (符合RECODE规则)
- [x] 置换完成日期 存在
- [x] 首次通知日 < 退市日期

> **RECODE 要点**：
> - 法人主体存续，仅简称和代码变更
> - 置换比例固定 1:1，持仓等值平移
> - 复牌日同时作为"退市日期"和"置换完成日期"

### 案例 4: 校验失败示例

**提取结果：**
```json
{
  "code": "600XXX",
  "名称": "某某公司",
  "退市日期": "2024-06-15",
  "退市原因": "被某公司吸收合并",
  "退市类型": "MERGE",
  "首次退市通知日": "2024-05-01",
  "置换标的code": "NaN",  // ❌ 问题所在
  "置换标的名称": "NaN",  // ❌ 问题所在
  "置换比例": "NaN",      // ❌ 问题所在
  "置换完成日期": "NaN",  // ❌ 问题所在
  ...
}
```

**校验结果：❌ 失败**

```
❌ 校验失败

股票代码: 600XXX
股票名称: 某某公司
错误类型: FIELD_CONFLICT
错误详情: 退市类型为 MERGE，但置换相关字段为空

根据规则，MERGE 类型必须包含以下字段：
- 置换标的code: 当前值 "NaN"，应为6位股票代码
- 置换标的名称: 当前值 "NaN"，应为公司名称
- 置换比例: 当前值 "NaN"，应为 "1:X.XXXX" 格式
- 置换完成日期: 当前值 "NaN"，应为日期

需要用户处理:
1. 请检查是否下载了正确的换股方案公告
2. 如果确实无法获取置换信息，请确认退市类型是否正确
3. 提供正确的值，或同意标记为 "待确认" 继续
```

---

## 清理

分析完成后删除临时文件：
```bash
Remove-Item temp/*.pdf, temp/*.json -ErrorAction SilentlyContinue
```

---

# 模式二：实时监控（持仓风险预警）

## 目的

每日扫描持仓股票，检测退市风险信号，确保实盘不持有即将退市的股票。

## 风险信号等级

| 等级 | 信号类型 | 关键词特征 | 行动建议 | 时间窗口 |
|-----|---------|----------|---------|---------|
| 🔴 **紧急** | 股东大会决议通过退市/合并 | "股东大会决议...终止上市"、"股东大会通过...吸收合并" | **立即清仓** | 可能仅剩几天 |
| 🔴 **紧急** | 交易所决定终止上市 | "终止上市的决定"、"摘牌公告" | **立即清仓** | 即将停牌 |
| 🟠 **高风险** | 董事会通过退市/合并预案 | "董事会通过...换股吸收合并预案"、"主动终止上市预案" | 尽快减仓 | 数周到数月 |
| 🟡 **中风险** | 触发退市条件警告 | "触发退市条件"、"可能终止上市的风险提示" | 设置止损 | 需要持续关注 |
| 🟡 **中风险** | 连续亏损/净资产为负 | "连续亏损"、"净资产为负" | 设置止损 | 需要持续关注 |
| 🟢 **低风险** | 筹划重大事项停牌 | "筹划重大资产重组"、"筹划重大事项停牌" | 观察 | 不确定是否退市 |

## 扫描流程

### 步骤 1: 获取持仓列表

从策略或账户获取当前持仓股票代码列表。

### 步骤 2: 扫描每只股票的最新公告

对于每只持仓股票，获取最近30天的公告：

```bash
$env:PYTHONIOENCODING='utf-8'; python .agent/skills/delist-analysis/scripts/cninfo_tools.py list-announcements <stock_code> --limit 30 --sort desc
```

### 步骤 3: 检测风险信号

**检测规则（按优先级）：**

```
for each 公告 in 公告列表:
    if 公告标题 contains ["股东大会决议", "终止上市", "摘牌"]:
        → 🔴 紧急风险
    elif 公告标题 contains ["换股吸收合并预案", "主动终止上市", "董事会决议...合并"]:
        → 🟠 高风险
    elif 公告标题 contains ["触发退市条件", "可能终止上市", "连续亏损", "净资产为负"]:
        → 🟡 中风险
    elif 公告标题 contains ["筹划重大资产重组", "筹划重大事项"]:
        → 🟢 低风险
```

### 步骤 4: 生成风险报告

输出格式：
```
========================================
持仓退市风险扫描报告
扫描日期: YYYY-MM-DD
持仓数量: XX
========================================

🔴 紧急风险 (需立即处理):
------------------------------------------
[601989] 中国重工
  公告日期: 2025-02-19
  公告标题: 中国重工2025年第一次临时股东大会决议公告
  风险等级: 紧急
  行动建议: 立即清仓，股票即将停牌并退市

🟠 高风险 (建议减仓):
------------------------------------------
(无)

🟡 中风险 (设置止损):
------------------------------------------
(无)

🟢 低风险 (持续关注):
------------------------------------------
(无)

✅ 无风险:
XX 只股票无退市风险信号
========================================
```

## 风险信号示例

### 🔴 紧急信号示例

| 公告标题 | 风险 | 行动 |
|---------|------|------|
| "关于以股东大会决议方式主动终止公司股票上市的公告" | 🔴 | 立即清仓 |
| "关于公司股票终止上市的公告" | 🔴 | 立即清仓 |
| "中国船舶换股吸收合并中国重工...股东大会决议公告" | 🔴 | 立即清仓 |
| "关于本次终止上市事项的停牌公告" | 🔴 | 已停牌，无法操作 |

### 🟠 高风险信号示例

| 公告标题 | 风险 | 行动 |
|---------|------|------|
| "换股吸收合并暨关联交易预案" | 🟠 | 尽快减仓 |
| "关于收到深圳证券交易所事先告知书的公告" | 🟠 | 尽快减仓 |

### 🟡 中风险信号示例

| 公告标题 | 风险 | 行动 |
|---------|------|------|
| "关于公司股票可能终止上市的风险提示公告" | 🟡 | 设置止损 |
| "关于公司股票触发退市条件的公告" | 🟡 | 设置止损 |

### 🟢 低风险信号示例

| 公告标题 | 风险 | 行动 |
|---------|------|------|
| "关于筹划重大资产重组停牌公告" | 🟢 | 观察 |
| "关于控股股东筹划重大事项的公告" | 🟢 | 观察 |

## 自动化建议

### 每日扫描时机

| 时间 | 建议 |
|-----|------|
| **盘前 (8:30)** | 扫描前一日发布的公告 |
| **盘后 (15:30)** | 扫描当日发布的公告 |

### 与交易系统集成

1. **高风险以上**：自动生成平仓指令或提醒
2. **中风险**：添加到监控列表
3. **低风险**：记录日志，人工判断

## 局限性说明

1. **公告延迟**：部分公告可能在盘后才发布，无法盘中预警
2. **语义理解**：需要 Agent 判断公告的实际含义
3. **历史公告**：本扫描仅检查最近公告，不检查历史状态
4. **停牌风险**：如果扫描时股票已停牌，可能已无法卖出
